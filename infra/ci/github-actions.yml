# ============================================
# POWERSTREAM CI/CD PIPELINE
# GitHub Actions Workflow
# ============================================

name: PowerStream CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  
jobs:
  # ========================================
  # LINT & TEST
  # ========================================
  test:
    name: Test
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
      
      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci
      
      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Lint Backend
        run: |
          cd backend
          npm run lint --if-present
      
      - name: Lint Frontend
        run: |
          cd frontend
          npm run lint --if-present
      
      - name: Test Backend
        run: |
          cd backend
          npm test --if-present
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/powerstream_test
          JWT_SECRET: test-secret-key-for-ci
      
      - name: Test Frontend
        run: |
          cd frontend
          npm test --if-present

  # ========================================
  # BUILD
  # ========================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
      
      - name: Build Studio App
        run: |
          cd frontend/studio-app
          npm ci
          npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_STUDIO_API_URL }}
      
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7
      
      - name: Upload Studio Artifact
        uses: actions/upload-artifact@v4
        with:
          name: studio-dist
          path: frontend/studio-app/dist
          retention-days: 7

  # ========================================
  # DEPLOY STAGING
  # ========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
      
      - name: Download Studio Artifact
        uses: actions/download-artifact@v4
        with:
          name: studio-dist
          path: frontend/studio-app/dist
      
      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /var/www/powerstream-staging
            git pull origin develop
            cd backend && npm ci --production
            pm2 reload ecosystem.config.cjs --env staging

  # ========================================
  # DEPLOY PRODUCTION
  # ========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
      
      - name: Download Studio Artifact
        uses: actions/download-artifact@v4
        with:
          name: studio-dist
          path: frontend/studio-app/dist
      
      - name: Create Deployment Package
        run: |
          tar -czf deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            backend frontend/dist frontend/studio-app/dist infra
      
      - name: Deploy to Production
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/tmp/"
      
      - name: Execute Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            # Backup current
            cp -r /var/www/powerstream /var/www/powerstream_backup_$(date +%Y%m%d_%H%M%S)
            
            # Extract new deployment
            cd /var/www/powerstream
            tar -xzf /tmp/deploy.tar.gz
            
            # Install dependencies
            cd backend && npm ci --production
            
            # Reload PM2 (zero-downtime)
            pm2 reload ecosystem.config.cjs --env production
            
            # Health check
            sleep 5
            curl -f http://localhost:5001/api/health || exit 1
            
            # Cleanup
            rm -f /tmp/deploy.tar.gz
            ls -dt /var/www/powerstream_backup_* | tail -n +4 | xargs rm -rf

  # ========================================
  # BUILD iOS
  # ========================================
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: build
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[ios]')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build Web
        run: |
          cd frontend
          npm run build
      
      - name: Sync Capacitor
        run: |
          cd frontend
          npx cap sync ios
      
      - name: Install CocoaPods
        run: |
          cd frontend/ios/App
          pod install
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install Fastlane
        run: gem install fastlane
      
      - name: Build & Upload to TestFlight
        run: |
          cd infra/mobile/ios
          fastlane beta
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

  # ========================================
  # BUILD ANDROID
  # ========================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[android]')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build Web
        run: |
          cd frontend
          npm run build
      
      - name: Sync Capacitor
        run: |
          cd frontend
          npx cap sync android
      
      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > frontend/android/app/keystore.jks
      
      - name: Build AAB
        run: |
          cd frontend/android
          ./gradlew bundleRelease
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      
      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: tv.powerstream.app
          releaseFiles: frontend/android/app/build/outputs/bundle/release/app-release.aab
          track: internal



